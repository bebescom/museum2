<!DOCTYPE html>
<html>
<head>
    <title>ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š</title>
    <meta charset='utf-8'>
    <link href="easyui/themes/default/easyui.css" rel="stylesheet" type="text/css"/>
    <link href="easyui/themes/icon.css" rel="stylesheet" type="text/css"/>
    <link href="css/init.css" rel="stylesheet" type="text/css"/>
    <style>
        #museum_name {
            color: #00d;
        }
    </style>
    <script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/underscore-min.js"></script>
    <script type="text/javascript" src="js/store2.min.js"></script>

    <script type="text/javascript" src="js/vue.min.js"></script>
    <script type="text/javascript" src="element/element.min.js"></script>

    <script type="text/javascript" src="easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="easyui/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="easyui/window.js"></script>

    <script type="text/javascript" src="js/socket.io.min.js"></script>
    <script type="text/javascript" src="js/my.socket.io.js"></script>

    <script type="text/javascript" src="js/init.js"></script>
</head>

<body>

<div id="cc" class="easyui-layout" data-options="fit:true">

    <div data-options="region:'north',title:'åˆ‡æ¢æ•°æ®æºï¼Œå­˜åœ¨å¤šä¸ªæ•°æ®åº“æ‰ç”Ÿæ•ˆ'" style="height:70px;padding:10px 10px;">

        é€‰æ‹©æ•°æ®åº“ï¼š
        <select name="db" id="db">

        </select>
        æ³¨ï¼šé€‰æ‹©æ•°æ®åº“å°†é‡å¯ç¨‹åºï¼Œä¿®æ”¹é…ç½®ï¼Œéœ€è¦ç­‰å¾…ä¸€ä¼šï¼Œä¸”æ­¤æ“ä½œå…·æœ‰å…¨å±€å”¯ä¸€æ€§ï¼Œä¸èƒ½å¤šäººè¿›è¡Œæ“ä½œã€‚

    </div>
    <div data-options="region:'west',title:'æ‰‹åŠ¨ç”ŸæˆæŠ¥å‘Š',split:true" style="width:500px;">

        <div id="operate" style="height: 125px;padding:1%;display: none;">
            <div id="sensorText" style="padding-bottom: 3px;line-height: 1.5"></div>
            <input class="easyui-textbox" style="width: 40%;height: 25px;line-height: 25px;" name="times" id="times"
                   placeholder="æ—¶é—´æ®µ"/>
            <a class="easyui-linkbutton" data-options="iconCls:'icon-add'" href="javascript:create_report()">ç”ŸæˆæŠ¥å‘Š</a>
            <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'"
               href="javascript:stop_report()">åœæ­¢è¿è¡Œ</a>

            <div style="padding: 5px 0;line-height: 1.5">
                æ—¶é—´æ®µ:20170501-20180501,å­£åº¦:2017[1-4],æœˆåº¦:2017[01-12],å¹´åº¦:2017,
                <br/>
                æŒ‡å®šæŠ¥è¡¨IDé‡æ–°ç”Ÿæˆå›¾ç‰‡æˆ–wordï¼šimg 1,docx 2,imgdocx 2
            </div>
            <div>
                <a class="easyui-linkbutton" data-options="iconCls:'icon-reload'"
                   href="javascript:pull_code()">pullä»£ç </a>
                ç³»ç»Ÿæ¯ä¸ªå­£åº¦ç¬¬ä¸€å¤©è‡ªåŠ¨ç”Ÿæˆä¸Šä¸€å­£åº¦çš„æŠ¥å‘Š

            </div>
        </div>
        <pre id="report_data"
             style="border: 1px solid #ccc;height: calc(100% - 140px);width: 98%;overflow: auto;white-space: pre-wrap;word-wrap: break-word;margin: 0 auto;"></pre>

    </div>
    <div data-options="region:'center',title:'è¯„ä¼°æŠ¥å‘Šåˆ—è¡¨(<span id=\'museum_name\'></span>)',split:true" style="width:50%;">
        <table id="sensorgrid"></table>
    </div>

</div>

<script type="text/javascript">
    

    socket.on('connect', function () {
        $('#sensorText').html('<span style="color: #0b0;">è¿æ¥æœåŠ¡æˆåŠŸ</span>');
        socket.emit('report');
        $.messager.progress({
            title:'Please waiting',
            msg:'Loading data...'
        });

        load_db(function () {
            searchSensor();
            $.messager.progress('close');
        });
    });

    socket.on('report_reload', function () {
        console.log('report_reload');
        searchSensor();
    });

    socket.on('report_data', function (data) {
        console.log('report_data');
        var $text = $('#report_data');
        var $str = data.replace(/\[\S*\s/g, ' ').trim() + "\r\n\r\n";
        $text.append($str);
        var scrollTop = $text[0].scrollHeight;
        $text.scrollTop(scrollTop);
    });

    function searchSensor() {
        var json = {};
        json.db = $('#db').val();
        if (!json.db) {
            console.log('db is null');
            return;
        }
        if (searchSensor.loading) {
            return;
        }
        if (searchSensor.init) {
            $('#sensorgrid').datagrid('load', json);
            return;
        }

        $('#sensorgrid').datagrid({
            url: 'report/list',
            queryParams: json,
            singleSelect: true,
            rownumbers: true,
            fit: true,
            border: false,
            pagination: true,
            pageSize: 50,
            remoteSort: false,
            fitColumns: true,
            onDblClickRow: function (index, row) {
                open_report(row);
            },
            columns: [
                [
                    {field: 'id', width: 50, title: 'æŠ¥è¡¨ID'},
                    {field: 'museum_name', width: 150, title: 'åšç‰©é¦†åç§°'},
                    {field: 'report_type', width: 80, title: 'æŠ¥è¡¨ç±»å‹'},
                    {field: 'report_name', width: 150, title: 'æŠ¥è¡¨åç§°'},
                    {field: 'report_time_range', width: 150, title: 'æ—¶é—´èŒƒå›´'},
                    {
                        field: 'generate_time', width: 150, title: 'ç”Ÿæˆæ—¶é—´', formatter: function (value) {
                        return new Date(value * 1000).Format('yyyy-MM-dd hh:mm:ss');
                    }
                    },
                    {field: 'generate_status', width: 60, title: 'çŠ¶æ€'},
                    {
                        field: 'generate_total_time', width: 60, title: 'æ‰§è¡Œæ—¶é—´',
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return '';
                            } else if (value < 60) {
                                return value + 's';
                            } else {
                                return (value / 60).toFixed(0) + 'm';
                            }
                        }
                    },
                    {
                        field: 'report_file', width: 80, title: 'ä¸‹è½½', sortable: true,
                        formatter: function (value, row, index) {
                            if (row.report_file) {
                                return '<a href="report/down?file=' + row.report_file + '" target="_blank">ç‚¹å‡»ä¸‹è½½</a>';
                            }
                            return '';
                        }
                    }
                ]
            ],
            onLoadSuccess: function () {
                searchSensor.loading = false;
            }
        });
        searchSensor.init = true;
        searchSensor.loading = true;
    }

    searchSensor.init = false;

    function load_db(callback) {

        var $db = $('#db');

        var $times = $('#times');

        $db.empty();

        store.session('times') && $times.textbox('setValue', store.session('times'));

        $.post('report/db', function (data) {

            if (!data || !data['list']) {
                callback && callback();
                return;
            }

            _.each(data.list, function (row) {
                $db.append('<option value="' + row.db_name + '">' + row.db_name + '</option>');
            });
            store.session('db', data.now);
            $db.val(data.now);
            $('#museum_name').text(data.museum_name + '-' + new Date(data.max_equip_time * 1000).Format("yyyy-M-d h:m:s"));
            $db.change(function () {
                var db = $db.val();
                $.messager.confirm("ç¡®è®¤åˆ‡æ¢æ•°æ®æº", 'æ­¤æ“ä½œå…·æœ‰å”¯ä¸€æ€§ï¼Œä¸èƒ½å¤šäººè¿›è¡Œæ“ä½œï¼Œç¡®è®¤åˆ‡æ¢ï¼Ÿ', function (r) {
                    if (r) {
                        $.post('report/change_db', {db: db}, function (data) {
                            if (data.error) {
                                $.messager.alert('é”™è¯¯', data.error);
                                return;
                            }
                        });
                    } else {
                        $db.val(store.session('db'));
                    }
                });
            });
            $('#operate').show();
            callback && callback();

        });

    }


    function pull_code() {
        socket.emit('report_pull');
    }

    function create_report() {
        var $times = $('#times').textbox('getValue');
        store.session('times', $times);
        socket.emit('report_create', {times: $times});
        setTimeout(searchSensor, 5000);
    }

    function stop_report() {

        socket.emit('report_stop');

    }

    function open_report(report) {
        $.window({
            winId: 'reportWin',
            title: report.report_name,
            ajaxType: 'get',
            width: 1100,
            height: 510,
            url: 'report_info.html?v=' + new Date().getTime(),
            onComplete: function () {
                $('#report_id').val(report.id);
                var search_report = store.session('search_report') || {};
                $('#table').combobox('setValue', search_report.table || 'content');
                $('#key').textbox('setValue', search_report.key || '');
                searchReport();
            }
        });
    }


    function searchReport() {
        var json = {};
        json.report_id = $('#report_id').val();
        json.table = $('#table').combobox('getValue');
        json.key = $('#key').textbox('getValue');

        if (!table_columns[json.table]) {
            return;
        }
        store.session('search_report', json);

        $('#reportDataGrid').datagrid({
            url: 'report/info',
            toolbar: '#reportTool',
            queryParams: json || {},
            fit: true,
            border: false,
            singleSelect: true,
            rownumbers: true,
            pagination: true,
            pageSize: 15,
            pageList:[10,15,20,30,50],
            fitColumns: true,
            columns: [table_columns[json.table]],
            onLoadSuccess: function () {
                $('.img').tooltip({
                    content: function () {
                        return "<img src='" + $(this).attr('href') + "' style='width: 400px;'>";
                    }
                });
            }
        })
    }

    var table_columns = {
        content: [
            {field: 'content_key', width: 300, title: 'æ–‡æœ¬key'},
            {field: 'content_value', width: 700, title: 'æ–‡æœ¬val'}
        ],
        images: [
            {field: 'id', width: 100, title: 'ID'},
            {field: 'image_key', width: 300, title: 'å›¾ç‰‡key'},
            {
                field: 'image_url', width: 700, title: 'å›¾ç‰‡åœ°å€',
                formatter: function (value) {
                    var str = '';
                    if (value) {
                        str += '<a class="img" href="report/image?file=' + value + '?v=' + new Date().getTime() + '" target="_blank">' + value + '</a>';
                    }
                    return str;
                }
            },
            {
                field: 'image_data', width: 700, title: 'å›¾ç‰‡æ•°æ®',
                formatter: function (value, row, index) {

                    return '<textarea rows="3" style="width: 100%">' + unescape(value.replace(/\\/g, "%")) + '</textarea>';
                }
            }
        ],
        table_data_desc: [
            {field: 'sheet_name', width: 300, title: 'è¡¨æ ¼æ ‡é¢˜'},
            {field: 'env_name', width: 200, title: 'ç¯å¢ƒåç§°'},
            {field: 'total_count', width: 80, title: 'N(æ•°æ®é‡)'},
            {field: 'range', width: 80, title: 'å…¨è·'},
            {field: 'min', width: 80, title: 'æå°å€¼'},
            {field: 'max', width: 80, title: 'æå¤§å€¼'},
            {field: 'avg', width: 80, title: 'å‡å€¼'},
            {field: 'std', width: 80, title: 'æ ‡å‡†å·®'}
        ],
        table_rang_std_day: [
            {field: 'sheet_name', width: 300, title: 'è¡¨æ ¼æ ‡é¢˜'},
            {field: 'env_name', width: 200, title: 'ç¯å¢ƒåç§°'},
            {field: 'range_max', width: 80, title: 'æ—¥æ³¢åŠ¨æœ€å¤§å€¼'},
            {field: 'range_min', width: 80, title: 'æ—¥æ³¢åŠ¨æœ€å°å€¼'},
            {field: 'range_avg', width: 80, title: 'æ—¥æ³¢åŠ¨å‡å€¼'},
            {field: 'std_max', width: 80, title: 'æ ‡å‡†å·®æœ€å¤§å€¼'},
            {field: 'std_min', width: 80, title: 'æ ‡å‡†å·®æœ€å°å€¼'},
            {field: 'std_avg', width: 80, title: 'æ ‡å‡†å·®å‡å€¼'}
        ],
        table_rang_std_date: [
            {field: 'sheet_name', width: 300, title: 'è¡¨æ ¼æ ‡é¢˜'},
            {field: 'env_name', width: 200, title: 'ç¯å¢ƒåç§°'},
            {field: 'range_max_date', width: 100, title: 'æ—¥æ³¢åŠ¨æœ€å¤§æ—¥æœŸ'},
            {field: 'range_min_date', width: 100, title: 'æ—¥æ³¢åŠ¨æœ€å°æ—¥æœŸ'},
            {field: 'std_max_date', width: 100, title: 'æ ‡å‡†å·®æœ€å¤§æ—¥æœŸ'},
            {field: 'std_min_date', width: 100, title: 'æ ‡å‡†å·®æœ€å°æ—¥æœŸ'}
        ]
    }
    
</script>
</body>
</html>